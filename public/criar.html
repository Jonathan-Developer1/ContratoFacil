<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Criar Notifica√ß√£o</title>
  <link rel="stylesheet" href="assets/css/notificacoes.css" />
</head>

<body>
  <!-- ============================
       Menu Lateral
  ============================ -->
  <aside class="sidebar">
      <div class="logo">
        <img src="assets/imgs/Logo_ContratoFacil.png" alt="">
        <h1>ContratoF√°cil</h1>
      </div>
      <div id="perfil">
        <img src="assets/imgs/perfil.png" alt="">
      <span id="nome-usuario"></span>
      </div>
      
      <nav>
        <ul>
          <li><a href="dashboard-gestor.html">Painel de controle</a></li>
          <li><a href="contratos-exibicao.html">Contratos</a></li>
          <li><a href="telaNotificacoes.html">Notifica√ß√µes</a></li>
          <li><a href="configuracoes.html">Configura√ß√µes</a></li>
          <li><a href="login.html" id="sair" class="sair">Sair</a></li>

        </ul>
      </nav>
    </aside>

  <!-- ============================
       Conte√∫do Principal
  ============================ -->
  <main class="conteudo"> <!-- √Årea principal do conte√∫do -->
    <h1>Criar Notifica√ß√£o</h1> <!-- T√≠tulo principal da p√°gina -->

    <!-- ============================
         Formul√°rio de Cria√ß√£o/Edi√ß√£o
    ============================ -->
    <form id="form-notificacao"> <!-- Formul√°rio de cria√ß√£o/edi√ß√£o de notifica√ß√£o -->

      <label for="titulo">T√≠tulo da notifica√ß√£o</label>
      <input type="text" id="titulo" required /> <!-- Campo de texto obrigat√≥rio para o t√≠tulo -->

      <label for="descricao">Descri√ß√£o</label>
      <textarea id="descricao" rows="4" required></textarea> <!-- Campo de texto para a descri√ß√£o -->

      <label for="destinatario">Destinat√°rio</label>
      <input type="text" id="destinatario" placeholder="Digite o CPF (apenas o numeros, sem pontos)" required />
      <!-- Campo de destinat√°rio com placeholder -->

      <label for="validade">Validade</label>
      <input type="date" id="validade" required /> <!-- Campo de data obrigat√≥ria -->

      <label for="status">Status</label>
      <select id="status" required> <!-- Campo de sele√ß√£o obrigat√≥rio -->
        <option value="Pendente">Pendente</option> <!-- Op√ß√£o padr√£o -->
        <option value="Conclu√≠do">Conclu√≠do</option> <!-- Outra op√ß√£o -->
      </select>

      <!-- ============================
           Bot√µes de A√ß√£o
      ============================ -->
      <div class="botoes-form"> <!-- √Årea dos bot√µes -->
        <button type="submit" class="salvar">SALVAR NOTIFICA√á√ÉO</button> <!-- Envia o formul√°rio -->
        <button type="button" id="cancelar">CANCELAR</button> <!-- Cancela e volta para a lista -->
      </div>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const form = document.getElementById('form-notificacao');
      const editandoId = localStorage.getItem('editando');
      console.log("üìå ID de edi√ß√£o carregado:", editandoId);

      if (editandoId) {
        try {
          const resposta = await fetch('http://localhost:3000/notificacoes');
          const notificacoes = await resposta.json();
          const n = notificacoes.find(n => n.id == editandoId);
          console.log("üìå Notifica√ß√£o encontrada:", n);

          if (n) {
            document.getElementById('titulo').value = n.titulo || '';
            document.getElementById('descricao').value = n.descricao || '';
            document.getElementById('destinatario').value = n.destinatario || '';
            document.getElementById('validade').value = n.validade || '';
            document.getElementById('status').value = n.status || '';
          }
        } catch (erro) {
          alert('Erro ao carregar dados para edi√ß√£o.');
          console.error(erro);
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const notificacao = {
          titulo: document.getElementById('titulo').value.trim(),
          descricao: document.getElementById('descricao').value.trim(),
          destinatario: document.getElementById('destinatario').value.trim(),
          validade: document.getElementById('validade').value,
          status: document.getElementById('status').value
        };

        try {
          if (editandoId) {
            const url = `http://localhost:3000/notificacoes/${editandoId}`;
            console.log("üìå Enviando PUT para:", url);

            const resposta = await fetch(url, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(notificacao)
            });

            if (!resposta.ok) {
              const erroTexto = await resposta.text();
              console.error('üìõ Erro na resposta do PUT:', erroTexto);
              throw new Error('Erro ao editar notifica√ß√£o');
            }

            localStorage.removeItem('editando');
          } else {
            const resposta = await fetch('http://localhost:3000/notificacoes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(notificacao)
            });
            if (!resposta.ok) throw new Error('Erro ao salvar notifica√ß√£o');
          }
          window.location.href = 'telaNotificacoes.html';
          alert('Notifica√ß√£o salva com sucesso!');

        } catch (erro) {
          alert('Erro: ' + erro.message);
          console.error(erro);
        }
      });
      document.getElementById('cancelar').addEventListener('click', () => {
        localStorage.removeItem('editando'); // Limpa o ID de edi√ß√£o
        window.location.href = 'telaNotificacoes.html';
      });

    });

  </script>
  <script src="assets/script/get-contrato.js"></script>
  <script src="assets/script/login.js"></script>
</body>

</html>